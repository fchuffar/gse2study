---
title: "Repeated sequences"
author: "Florent Chuffart"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---


```{r, echo=FALSE, eval=TRUE}
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=6, eval=TRUE, echo=FALSE, results="hide")
source("config")
source("config.R")
```

```{r}
# GSM2684052_telocentro.unmapblasted.txt.gz
if (!file.exists("telocentro_unmapblasted.rds")) {
  gsms = unique(design$gsm)
  
  if (!exists("mgzread.table")) {
    gzread.table = function(fn, ...) read.table(gzfile(fn), ...)
    mgzread.table = memoise::memoise(gzread.table)
  }


  for (gsm in gsms) {
    fn = paste0("~/projects/datashare/", gse, "/", gsm, "_telocentro.unmapblasted.txt.gz")
    print(fn)
    foo = mgzread.table(fn, sep=",", stringsAsFactors=FALSE)
  }

  sseqids = names(seqinr::read.fasta("~/projects/heatshock/data/telocentro.fasta"))
  sseqs = unlist(seqinr::getSequence(seqinr::read.fasta("~/projects/heatshock/data/telocentro.fasta"), as.string = TRUE))
  names(sseqs) = sseqids
  sseqs

  foo = lapply(gsms, function(gsm) {
    fn = paste0("~/projects/datashare/", gse, "/", gsm, "_telocentro.unmapblasted.txt.gz")
    print(fn)
    foo = mgzread.table(fn, sep=",", stringsAsFactors=FALSE)
    colnames(foo) = c("qseqid", "sseqid", "pident", "length", "mismatch", "gapopen", "qstart", "qend", "sstart", "send", "evalue", "bitscore", "sstrand")
    # foo$sseqid_strand =   factor(foo$sseqid_strand, levels=paste(rep(sseqids, each=2), unique(foo$sstrand), sep="_"))
    foo$sseqid = factor(foo$sseqid, levels=sseqids)
    foo$sstrand = factor(foo$sstrand, levels=c("plus", "minus"))
    foo$sseqid_strand = interaction(foo$sseqid, foo$sstrand)

    head(foo)
    dim(foo)
    # print(table(foo$sseqid))
    bar = foo[
      (foo$sseqid %in% "seq_ggaat2"  & foo$length==10) |
      (foo$sseqid %in% "seq_ggaat3"  & foo$length==15) |
      (foo$sseqid %in% "seq_ggaat4"  & foo$length==20) |
      (foo$sseqid %in% "seq_ggaat5"  & foo$length==25) |
      (foo$sseqid %in% "seq_ttaggg2" & foo$length==12) |
      (foo$sseqid %in% "seq_ttaggg3" & foo$length==18) |
      (foo$sseqid %in% "seq_ttaggg4" & foo$length==24) |
      (foo$sseqid %in% "seq_ttaggg5" & foo$length==30) |
      FALSE
    ,]
    head(bar)
    dim(bar)
    bar = bar[!duplicated(paste(bar$sseqid, bar$qseqid, bar$qstart, sep="_")),]
    dim(bar)
    # bar = bar[!duplicated(paste(bar$sseqid, bar$qseqid, bar$sstrand, sep="_")),]
    # dim(bar)
    # table(foo[!duplicated(paste(foo$sseqid, foo$qseqid, sep="_")),]$sseqid)
    res = table(bar$sseqid_strand)
    # res = table(bar$sseqid,bar$sstrand)
    # res = table(bar$sseqid)
    print(res)
    return(res)
  })

  foo = do.call(rbind, foo)
  # foo = foo[,sseqids]
  # colnames(foo) = seqs[sseqids]
  foo = data.frame(foo)
  rownames(foo) = gsms
  head(foo)
  foo$cond = design[rownames(foo),]$cond
  head(foo)

  saveRDS(foo, "telocentro_unmapblasted.rds")
}

telocentro_blasted = readRDS("telocentro_unmapblasted.rds")
saveRDS(t(telocentro_blasted[,-ncol(telocentro_blasted)]), "raw_counts_telocentro.rds")
```


```{r, label="boxploting"}
head(telocentro_blasted)
dim(telocentro_blasted)
d = data.frame(
  cnt = unlist(lapply(telocentro_blasted[1:(ncol(telocentro_blasted)-1)], identity)),     
  seq = rep(colnames(telocentro_blasted)[-ncol(telocentro_blasted)], each=nrow(telocentro_blasted)), 
  cnd = telocentro_blasted[,ncol(telocentro_blasted)]
)
rownames(d) = NULL

# pdf("ggaat.pdf")
par(mar=c(7.1, 4.1, 4.1, 2.1))
boxplot(log2(cnt+1)~cnd+seq, d, las=2, main="log2(cnt)~cnd+seq", cex.axis=.5)
# dev.off()
```


# Session Information

```{r, results="verbatim"}
sessionInfo()
```














